function webgl_log(e){document.getElementById("dbg").innerHTML=e}function webgl_fatal(e){throw wgl_2d.fillStyle="red",wgl_2d.fillRect(0,0,wgl_canvas.width,wgl_canvas.height),wgl_2d.font="bold 64px sans-serif",wgl_2d.fillStyle="black",wgl_2d.textAlign="center",wgl_2d.fillText("誤",wgl_canvas.width/2,wgl_canvas.height/2),wgl_2d.font="0.7em sans-serif",wgl_2d.fillText(e,wgl_canvas.width/2,wgl_canvas.height/2+32),new Error(e)}function webgl_get(e,t,a){return null==t&&void 0===t&&(t=!1),null==a&&void 0===a&&(a=null),new Promise((n,l)=>{let i=new XMLHttpRequest;i.addEventListener("load",()=>{let e;e=t?i.response:i.responseText;null!=a&&a(e);n(e)});i.addEventListener("error",()=>{l("Error during transmit")});i.addEventListener("abort",()=>{l("User aborted operation")});i.addEventListener("timeout",()=>{l("Operation timed out")});i.responseType=t?"arraybuffer":"text";i.open("GET",e);i.send()})}function webgl_clear2d(){wgl_2d.clearRect(0,0,wgl_hud.width,wgl_hud.height),wgl_2d.font="10px sans-serif",wgl_2d.fillStyle="#fff",wgl_2d.textAlign="left",wgl_2d.fillText("Program by Team Raging",20,wgl_hud.height-4),wgl_2d.textAlign="right",wgl_2d.fillText("Art by Funcom",wgl_hud.width-20,wgl_hud.height-4)}function webgl_header_source(e){wgl_header=e}function webgl_create_program(e,t,a,n){function l(t,a){let n=gl.createShader(a);return gl.shaderSource(n,t),gl.compileShader(n),gl.getShaderParameter(n,gl.COMPILE_STATUS)?n:(webgl_log("Compile error: "+e+" : "+gl.getShaderInfoLog(n)),gl.deleteShader(n),null)}null==n&&void 0===n&&(n="");let i="";if(""!=n){let e=n.split(" ");e.forEach(e=>{let t="#define "+e+" 1\n";i+=t})}let r=l(wgl_header+(i+="\n#line 1\n")+t,gl.VERTEX_SHADER),_=l(wgl_header+i+a,gl.FRAGMENT_SHADER);if(!r||!_)return r&&gl.deleteShader(r),_&&gl.deleteShader(_),null;let o=gl.createProgram();if(gl.attachShader(o,r),gl.attachShader(o,_),gl.linkProgram(o),gl.detachShader(o,r),gl.deleteShader(r),gl.detachShader(o,_),gl.deleteShader(_),!gl.getProgramParameter(o,gl.LINK_STATUS))return webgl_log("Link error: "+e+" : "+gl.getProgramInfoLog(o)),gl.deleteProgram(o),null;gl.useProgram(o);let s={},d=gl.getProgramParameter(o,gl.ACTIVE_UNIFORMS);for(let e=0;e<d;e++){let t=gl.getActiveUniform(o,e),a=t.name.split("[")[0];s[a]=gl.getUniformLocation(o,a)}let g={},m=gl.getProgramParameter(o,gl.ACTIVE_ATTRIBUTES);for(let e=0;e<m;e++){let t=gl.getActiveAttrib(o,e);g[t.name]=e}return{_prog:o,uniform:s,attribute:g}}function webgl_image(e,t){null==t&&void 0===t&&(t=null);let a=gl.createTexture(),n=new Promise(n=>{let l="";let i=new Image;i.addEventListener("error",()=>{let t=e+".png";if(l!=t)return i.src=t,void(l=t);webgl_log("Failed to find .jpg or .png for "+t);n(!1)});i.addEventListener("load",()=>{wgl_image_ctx.canvas.width=i.width;wgl_image_ctx.canvas.height=i.height;wgl_image_ctx.drawImage(i,0,0);let e=wgl_image_ctx.getImageData(0,0,i.width,i.height);let l=e.data;for(let e=0;e<i.height;e++)for(let t=0;t<i.width;t++){let a=e*i.width+t<<2,n=l[a]<<16|l[a+1]<<8|l[a+2];65280==n&&(l[a+3]=0)}wgl_image_ctx.putImageData(e,0,0);let r=new Image;r.src=wgl_image_canvas.toDataURL();r.addEventListener("load",()=>{gl.activeTexture(gl.TEXTURE3);gl.bindTexture(gl.TEXTURE_2D,a);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,r);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);null!=t&&t(a);n(!0)})});i.src=e+".jpg"});return wgl_pending_images.push(n),a}function webgl_pending_images(e){return void 0==e&&(e=null),Promise.all(wgl_pending_images).then(()=>{wgl_pending_images.length=0;e&&e()})}function webgl_bindtexture(e,t){e<0||e>=wgl_tmu.length?webgl_log("Trying to use invalid TMU!"):(gl.activeTexture(gl.TEXTURE0+e),wgl_tmu[e]!=t&&(gl.bindTexture(gl.TEXTURE_2D,t),wgl_tmu[e]=t))}function webgl_init(){let e=document.getElementById("canvas").children;if(wgl_hud=e.namedItem("hud"),!(wgl_2d=wgl_hud.getContext("2d")))throw new Error("Failed to initialise 2D canvas");webgl_clear2d(),wgl_canvas=e.namedItem("gfx"),(gl=wgl_canvas.getContext("webgl"))||webgl_fatal("Failed to initalise WebGL")}function m4x4_identity(e){e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1}function m4x4_from_perspective(e,t,a,n,l){let i=n-l,r=1/Math.tan(Math.PI*t/360),_=r/a,o=(l+n)/i,s=l*n/i;e[0]=_,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=r,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=o,e[11]=-1,e[12]=0,e[13]=0,e[14]=s,e[15]=0}function m4x4_lookat(e,t,a){m4x4_identity(e);let n=a[0]-t[0],l=a[1]-t[1],i=a[2]-t[2],r=Math.sqrt(n*n+l*l+i*i);if(!r)return;let _=1/r,o=-(i*=_),s=0,d=n*=_,g=o*n+s*(l*=_)+d*i;o-=g*n,s-=g*l,d-=g*i;let m=(s*=r=1/Math.sqrt(o*o+s*s+d*d))*i-(d*=r)*l,u=d*n-(o*=r)*i,c=o*l-s*n;e[0]=o,e[4]=s,e[8]=d,e[1]=m,e[5]=u,e[9]=c,e[2]=-n,e[6]=-l,e[10]=-i,e[12]=-e[0]*t[0]-e[4]*t[1]-e[8]*t[2],e[13]=-e[1]*t[0]-e[5]*t[1]-e[9]*t[2],e[14]=-e[2]*t[0]-e[6]*t[1]-e[10]*t[2]}function m4x4_from_versor(e,t){let a=2*t[0],n=2*t[1],l=2*t[2],i=t[3]*a,r=t[3]*n,_=t[3]*l,o=t[0]*n,s=t[0]*l,d=t[1]*l,g=t[0]*a,m=t[1]*n,u=t[2]*l;e[0]=1-m-u,e[4]=o-_,e[8]=s+r,e[12]=0,e[1]=o+_,e[5]=1-g-u,e[9]=d-i,e[13]=0,e[2]=s-r,e[6]=d+i,e[10]=1-g-m,e[14]=0,e[3]=0,e[7]=0,e[11]=0,e[15]=1}function m4x4_multiply(e,t,a){for(let n=0;n<16;n+=4){let l=n+0,i=n+1,r=n+2,_=n+3;e[l]=t[l]*a[0]+t[i]*a[4]+t[r]*a[8]+t[_]*a[12],e[i]=t[l]*a[1]+t[i]*a[5]+t[r]*a[9]+t[_]*a[13],e[r]=t[l]*a[2]+t[i]*a[6]+t[r]*a[10]+t[_]*a[14],e[_]=t[l]*a[3]+t[i]*a[7]+t[r]*a[11]+t[_]*a[15]}}function m4x4_multiply_as_4x3(e,t,a){for(let n=0;n<12;n+=4){let l=n+0,i=n+1,r=n+2;e[l]=t[l]*a[0]+t[i]*a[4]+t[r]*a[8],e[i]=t[l]*a[1]+t[i]*a[5]+t[r]*a[9],e[r]=t[l]*a[2]+t[i]*a[6]+t[r]*a[10]}e[12]=t[12]*a[0]+t[13]*a[4]+t[14]*a[8]+a[12],e[13]=t[12]*a[1]+t[13]*a[5]+t[14]*a[9]+a[13],e[14]=t[12]*a[2]+t[13]*a[6]+t[14]*a[10]+a[14]}function m4x4_multiply_as_3x3(e,t,a){for(let n=0;n<12;n+=4){let l=n+0,i=n+1,r=n+2;e[l]=t[l]*a[0]+t[i]*a[4]+t[r]*a[8],e[i]=t[l]*a[1]+t[i]*a[5]+t[r]*a[9],e[r]=t[l]*a[2]+t[i]*a[6]+t[r]*a[10]}}function m4x4_translate(e,t,a,n){e[12]=t,e[13]=a,e[14]=n}function versor_multiply(e,t,a){e[0]=t[3]*a[0]+t[0]*a[3]+t[1]*a[2]-t[2]*a[1],e[1]=t[3]*a[1]+t[1]*a[3]+t[2]*a[0]-t[0]*a[2],e[2]=t[3]*a[2]+t[2]*a[3]+t[0]*a[1]-t[1]*a[0],e[3]=t[3]*a[3]-t[0]*a[0]-t[1]*a[1]-t[2]*a[2]}function versor_rotatex(e,t){let a=Math.PI*t/360;e[0]=Math.sin(a),e[1]=0,e[2]=0,e[3]=Math.cos(a)}function versor_rotatey(e,t){let a=Math.PI*t/360;e[0]=0,e[1]=Math.sin(a),e[2]=0,e[3]=Math.cos(a)}function versor_slerp(e,t,a,n){let l,i,r,_=new Float32Array(4);if(a<=0)return e[0]=t[0],e[1]=t[1],e[2]=t[2],void(e[3]=t[3]);if(a>=1)return e[0]=n[0],e[1]=n[1],e[2]=n[2],void(e[3]=n[3]);if(l=t[0]*n[0]+t[1]*n[1]+t[2]*n[2]+t[3]*n[3],l<0?(l=-l,_[0]=-n[0],_[1]=-n[1],_[2]=-n[2],_[3]=-n[3]):(_[0]=n[0],_[1]=n[1],_[2]=n[2],_[3]=n[3]),1-l>1e-5){let e=Math.acos(l),t=1/Math.sin(e);i=t*Math.sin(e*(1-a)),r=t*Math.sin(e*a)}else i=1-a,r=a;e[0]=i*t[0]+r*_[0],e[1]=i*t[1]+r*_[1],e[2]=i*t[2]+r*_[2],e[3]=i*t[3]+r*_[3]}function vec3_lerp(e,t,a,n){return a<=0?(e[0]=t[0],e[1]=t[1],void(e[2]=t[2])):a>=1?(e[0]=n[0],e[1]=n[1],void(e[2]=n[2])):(e[0]=t[0]+a*(n[0]-t[0]),e[1]=t[1]+a*(n[1]-t[1]),void(e[2]=t[2]+a*(n[2]-t[2])))}function tofloat32(e){let t=e>>15&1,a=e>>10&31;if(0==a)return t?-0:0;let n=(1023&e)/1024;if(31!=a){let e;return e=0==a?Math.pow(2,-14)*n:Math.pow(2,a-15)*(1+n),t?-e:e}return 0!=n?NaN:1/0}function Binary_reader(e){this.dv=new DataView(e),this.ofs=0,this.getint=function(){let e=this.dv.getUint32(this.ofs,!0);return this.ofs+=4,e},this.getint16=function(){let e=this.dv.getUint16(this.ofs,!0);return this.ofs+=2,e},this.getfloat=function(){let e=this.dv.getFloat32(this.ofs,!0);return this.ofs+=4,e},this.getvector=function(e){let t=[];for(let a=0;a<e;a++)t.push(this.getfloat());return t},this.getslice=function(e){let t=this.dv.buffer.slice(this.ofs,this.ofs+e);return this.ofs+=e,t},this.getarray=function(e){return this.getslice(e*this.getint())},this.getstring=function(){return String.fromCharCode.apply(null,new Uint8Array(this.getarray(1)))}}function parse_qs(){let e=window.location.href.split("?");if(e[1]){let t={},a=e[1].split("&");for(let e in a){let n=a[e].split("="),l=n[1];parseInt(l)&&(l=parseInt(l)),t[n[0]]=l}return t}return null}function load_abo(e){let t=new Binary_reader(e);if(558842433!=t.getint())return webgl_log("Mismatched model magick!"),null;if(538379523!=t.getint())return webgl_log("Mismatched model version!"),null;let a=t.getint(),n=[];for(let e=0;e<a;e++)n.push(t.getarray(1));let l=t.getint(),i=[];for(let e=0;e<l;e++){let e=t.getint();t.getint(),i.push(webgl_image("data/textures/"+e.toString()))}let r=t.getint(),_=[];for(let e=0;e<r;e++)t.getint(),_.push({diffuse:t.getvector(3),ambient:t.getvector(3),emissive:t.getvector(3),specular:t.getvector(3),shine:t.getfloat(),alpha:t.getfloat()});let o=t.getint(),s=[];for(let e=0;e<o;e++){let e=t.getint(),a=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,a),gl.bufferData(gl.ARRAY_BUFFER,t.getarray(32),gl.STATIC_DRAW);let n=gl.createBuffer(),l=new Uint16Array(t.getarray(2));gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,n),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,l,gl.STATIC_DRAW),s.push({slot:e,verts:a,nindices:l.length,indices:n})}return{skin:i,materials:_,meshes:s}}function load_cir2(e){let t=new Binary_reader(e);if(844253507!=t.getint())return webgl_log("Mismatched model magick!"),null;if(538379027!=t.getint())return webgl_log("Mismatched model version!"),null;let a=t.getint(),n=[];for(let e=0;e<a;e++)n.push(t.getstring());let l={},i=[],r=t.getint();for(let e=0;e<r;e++){let e=n[t.getint()];i.push(e),l[e]={ambient:t.getvector(3),diffuse:t.getvector(3),specular:t.getvector(3),emissive:t.getvector(3),shine:t.getfloat(),alpha:t.getfloat()}}let _=[],o=t.getint();for(let e=0;e<o;e++)t.getint(),_.push({parent:t.getint(),scale:t.getfloat()});let s={},d=t.getint();for(let e=0;e<d;e++){let e=n[t.getint()];s[e]={id:t.getint(),or:t.getvector(4),tr:t.getvector(3)}}let g=[],m=t.getint();for(let e=0;e<m;e++){let e=t.getint(),a=t.getarray(40),n=new Uint16Array(t.getarray(2)),l=gl.createBuffer();gl.bindBuffer(gl.ARRAY_BUFFER,l),gl.bufferData(gl.ARRAY_BUFFER,a,gl.STATIC_DRAW);let r=gl.createBuffer();gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,r),gl.bufferData(gl.ELEMENT_ARRAY_BUFFER,n,gl.STATIC_DRAW),g.push({slot:i[e],verts:l,nindices:n.length,indices:r})}return{bones:_,materials:l,attractors:s,meshes:g}}function load_cir2anim(e){let t=new Binary_reader(e);if(843664961!=t.getint())return webgl_log("Mismatched animation magick!"),null;if(538379032!=t.getint())return webgl_log("Mismatched animation version!"),null;let a=t.getfloat(),n=t.getint(),l=[];for(let e=0;e<n;e++){let e=[],a=new Binary_reader(t.getarray(12)),n=a.dv.buffer.byteLength/12;for(let t=0;t<n;t++)e.push({time:a.getfloat(),or:[tofloat32(a.getint16()),tofloat32(a.getint16()),tofloat32(a.getint16()),tofloat32(a.getint16())]});let i=[],r=new Binary_reader(t.getarray(16)),_=r.dv.buffer.byteLength/16;for(let e=0;e<_;e++)i.push({time:r.getfloat(),tr:[r.getfloat(),r.getfloat(),r.getfloat()]});l.push({r:{data:e,index:0},p:{data:i,index:0}})}return{length:a,bones:l}}function load_init(e){wgl_2d.fillStyle="#262626",wgl_2d.fillRect(0,0,wgl_canvas.width,wgl_canvas.height),wgl_2d.strokeStyle="orange",wgl_2d.strokeRect(wgl_canvas.width/2-180,wgl_canvas.height/2-16,360,32),wgl_2d.fillStyle="orange",wgl_2d.font="bold 64px sans-serif",wgl_2d.textAlign="center",wgl_2d.fillText("待",wgl_canvas.width/2,wgl_canvas.height/2-32),wgl_2d.font="0.7em sans-serif",wgl_2d.fillText(e,wgl_canvas.width/2,wgl_canvas.height/2+32)}function load_progress(e){wgl_2d.fillStyle="orange",wgl_2d.fillRect(wgl_canvas.width/2-177,wgl_canvas.height/2-13,354*e,26)}async function change_anim(e){if(!_anims)return;if(_anims[e])return _anim=_anims[e],void(_anim_time=0);let t=_sex_anims[_breed.sex];return webgl_get("data/"+_breed.sex+"/"+t[e]+".cir2anim",!0,function(t){_anim=load_cir2anim(t),_anims[e]=_anim,_anim_time=0})}function equip_change(){if(null==_equip_latched)return;let e={};return Object.keys(_breed.skin).forEach(t=>{webgl_image(_equip_latched[t],function(a){e[t]=a})}),_equip_latched=null,webgl_pending_images(function(){Object.keys(e).forEach(t=>{_equip[t]=e[t]})})}async function change_head(e){e<0?e=0:_breed.heads<=e&&(e=_breed.heads-1),await _head_req,_head_req=webgl_get("data/"+_breed.sex+"/"+_breed.breed+"/"+e+".abo",!0,async function(e){let t=load_abo(e);await webgl_pending_images(function(){for(let e=0;e<t.materials.length;e++)t.materials[e]=_mdl.materials.body;_head&&(_head.skin.forEach(e=>{gl.deleteTexture(e)}),_head.meshes.forEach(e=>{gl.deleteBuffer(e.verts);gl.deleteBuffer(e.indices)})),_head=t,_head_req=null})});let t=_breed.skin;"solitus"==_breed.breed&&("female"==_breed.sex?24==e?t=_breed.skin2:25<=e&&e<32?t=_breed.skin1:32<=e&&e<35?t=_breed.skin2:35==e?t=_breed.skin1:36<=e&&e<39&&(t=_breed.skin2):20<=e&&e<23?t=_breed.skin2:23<=e&&e<31?t=_breed.skin1:31<=e&&e<37?t=_breed.skin2:41==e&&(t=_breed.skin1));let a={};if(_breed_skin!=t){let e="data/"+_breed.sex+"/"+_breed.breed+"/";Object.keys(t).forEach(n=>{a[n]=webgl_image(e+t[n])}),await webgl_pending_images(function(){_body&&Object.keys(_body).forEach(e=>{gl.deleteTexture(_body[e])}),_body=a})}return _breed_skin=t,_breed.lasthead=e,_head_req}async function change_model(e){return await _mdl_req,_mdl_req=webgl_get("data/"+_breed.sex+"/"+_breed.breed+"/"+e+".cir2web",!0,function(e){_mdl&&_mdl.meshes.forEach(e=>{gl.deleteBuffer(e.verts);gl.deleteBuffer(e.indices)}),_mdl=load_cir2(e),_mdl_req=null}),_build=e,_mdl_req}async function breed_change(){if(null==_breed_latched)return;_inhibit=!0,load_init("Loading assets...");let e=document.getElementById("anims");if(null==_breed||_breed_latched.sex!=_breed.sex){_anims={};let t=_sex_anims[_breed_latched.sex];e.length=0,Object.keys(t).forEach(t=>{let a=document.createElement("option");a.text=t;e.add(a)})}e.selectedIndex=0,_equip_latched={},Object.keys(_breed_latched.skin).forEach(e=>{let t=_equip2[e];t||(t="data/"+_breed_latched.sex+"/"+_breed_latched.breed+"/"+_breed_latched.clothes[e]);_equip_latched[e]=t}),load_progress(.25),_breed=_breed_latched;let t=change_model(_build),a=change_head(_breed.lasthead);load_progress(.5),await t,load_progress(.62),await a,load_progress(.74),await equip_change(),load_progress(.86),await change_anim("idle"),load_progress(1),_pose.length=_mdl.bones.length;for(let e=0;e<_pose.length;e++)_pose[e]=new Float32Array(16);_vecs.length=12*_pose.length,_breed_latched=null,_inhibit=!1}function animate(e,t,a){function n(e,t){let a,n,l=e.index,i=e.data;if(1==i.length)return[0,i[0],i[0]];for(;;){let e=(l+1)%i.length;if(i[l].time<=t&&t<=i[e].time){a=i[l],n=i[e];break}l=e}return e.index=l,[(t-a.time)/(n.time-a.time),a,n]}let l=t.bones,i=t1,r=t2,_=t3;_dopause||(_anim_time+=a,_anim_time%=t.length);let o=_pose[0],s=n(l[0].r,_anim_time);versor_slerp(r,s[1].or,s[0],s[2].or);let d=n(l[0].p,_anim_time);vec3_lerp(_,d[1].tr,d[0],d[2].tr),m4x4_from_versor(o,r),m4x4_translate(o,_[0],_[1]-_breed.ofs[_build],_[2]),o[2]=-o[2],o[6]=-o[6],o[10]=-o[10],o[14]=-o[14];for(let t=1;t<l.length;t++){let a=e.bones[e.bones[t].parent].scale;versor_slerp(r,(s=n(l[t].r,_anim_time))[1].or,s[0],s[2].or),vec3_lerp(_,(d=n(l[t].p,_anim_time))[1].tr,d[0],d[2].tr);let g=_pose[e.bones[t].parent];o=_pose[t],m4x4_from_versor(i,r),m4x4_translate(i,_[0],_[1],_[2]),m4x4_multiply_as_3x3(o,i,g),o[12]=a*(i[12]*g[0]+i[13]*g[4]+i[14]*g[8])+g[12],o[13]=a*(i[12]*g[1]+i[13]*g[5]+i[14]*g[9])+g[13],o[14]=a*(i[12]*g[2]+i[13]*g[6]+i[14]*g[10])+g[14]}return _pose}async function aoview_frame(){function e(e){e!=i&&(gl.useProgram(e._prog),i=e)}function t(e,t,a,n,l,r){gl.vertexAttribPointer(i.attribute[e],t,a,n,l,r)}function a(t,a){void 0==a&&(a=!0),e(t),a&&(gl.uniformMatrix4fv(i.uniform._pm,!1,_pm),gl.uniformMatrix4fv(i.uniform._mm,!1,_mm),gl.uniformMatrix4fv(i.uniform._pmv,!1,_pmv)),gl.uniform4f(i.uniform._colour,1,1,1,1),gl.uniform3f(i.uniform._light_colour,1,.9,.95),gl.uniform3fv(i.uniform._light_pos,u),gl.uniform3fv(i.uniform._eye,_cam_pos),gl.uniform1i(i.uniform._map1,0),gl.uniform1i(i.uniform._map2,1)}function n(e,t,a){void 0==t&&(t=null),void 0==a&&(a=null);let n=[(null!=t)+0,(null!=a)*_doequip,0,0];gl.uniform3fv(i.uniform._diffuse,e.diffuse),gl.uniform3fv(i.uniform._ambient,e.ambient),gl.uniform3fv(i.uniform._specular,e.specular),gl.uniform3fv(i.uniform._emissive,e.emissive),gl.uniform1f(i.uniform._shininess,e.shine),gl.uniform1f(i.uniform._alpha,e.alpha),gl.uniform4fv(i.uniform._stages,n),n[0]&&webgl_bindtexture(0,t),n[1]&&webgl_bindtexture(1,a)}function l(e,a){let l=_mdl.attractors[a];m4x4_from_versor(t1,l.or),m4x4_translate(t1,l.tr[0],l.tr[1],l.tr[2]),m4x4_multiply_as_4x3(t2,t1,c[l.id]),m4x4_multiply(t1,t2,_mm),m4x4_multiply(t3,t1,_pm),gl.uniformMatrix4fv(i.uniform._mm,!1,t1),gl.uniformMatrix4fv(i.uniform._pmv,!1,t3);let r=[u[0]*t2[0]+u[1]*t2[4]+u[2]*t2[8]+t2[12],u[0]*t2[1]+u[1]*t2[5]+u[2]*t2[9]+t2[13],u[0]*t2[2]+u[1]*t2[6]+u[2]*t2[10]+t2[14]];gl.uniform3fv(i.uniform._light_pos,r),e.meshes.forEach(a=>{n(e.materials[a.slot],e.skin[a.slot],null);gl.bindBuffer(gl.ARRAY_BUFFER,a.verts);t("xyz",3,gl.FLOAT,!1,32,0);t("normal",3,gl.FLOAT,!0,32,12);t("uv",2,gl.FLOAT,!1,32,24);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,a.indices);gl.drawElements(gl.TRIANGLES,a.nindices,gl.UNSIGNED_SHORT,0)})}let i=null,r=performance.now(),_=r-_time,o=_/1e3;_time=r,await breed_change(),equip_change(),gl.clearColor(_colour[0],_colour[1],_colour[2],_colour[3]),gl.viewportWidth=wgl_canvas.width,gl.viewportHeight=wgl_canvas.height,gl.viewport(0,0,gl.viewportWidth,gl.viewportHeight),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),webgl_clear2d();let s=1e3/_;wgl_2d.fillStyle="#999",wgl_2d.textAlign="center",wgl_2d.font="10px sans-serif",wgl_2d.fillText("FPS: "+s.toFixed(0),wgl_canvas.width/2,wgl_canvas.height-4);for(let e=0;e<2;e++)_cam_angles[e]+=o*_velo[e],_velo[e]-=10*o*_velo[e],Math.abs(_velo[e])<=.001&&(_velo[e]=0);for(let e=0;e<3;e++)_cam_pos[e]+=o*_cam_velo[e],_cam_velo[e]-=10*o*_cam_velo[e],Math.abs(_cam_velo[e])<=.001&&(_cam_velo[e]=0);let d=Math.PI*_cam_angles[0]/180,g=Math.cos(d),m=Math.sin(d);m4x4_identity(t1),t1[0]=g,t1[2]=-m,t1[8]=m,t1[10]=g,d=Math.PI*_cam_angles[1]/180,g=Math.cos(d),m=Math.sin(d),m4x4_identity(t2),t2[5]=g,t2[6]=m,t2[9]=-m,t2[10]=g,m4x4_multiply(t3,t1,t2),m4x4_identity(t1),m4x4_translate(t1,0,-1.5,0),m4x4_multiply(t4,t1,t3),versor_rotatey(t1,_light_angles[0]),versor_rotatex(t2,_light_angles[1]),versor_multiply(t3,t2,t1),m4x4_from_versor(t1,t3);let u=[4*t1[2],4*t1[6],4*t1[10]],c=animate(_mdl,_anim,_),f=_vecs;if(_doskin){let e=0;for(let t=0;t<c.length;t++){let a=c[t];for(let t=0;t<3;t++)for(let n=0;n<4;n++)f[e++]=a[(n<<2)+t]}_skin=_pr_skin,_static=_pr_static,m4x4_from_perspective(_pm,90,wgl_canvas.width/wgl_canvas.height,.1,32),m4x4_identity(t2),t2[0]=_scale,t2[5]=_scale,t2[10]=_scale,m4x4_multiply(t3,t4,t2),m4x4_lookat(t1,[0,0,0],[0,0,-1]),m4x4_translate(t1,-_cam_pos[0],-_cam_pos[1],-_cam_pos[2]),m4x4_multiply(_mm,t3,t1),m4x4_multiply(_pmv,_mm,_pm),a(_skin),gl.uniform4fv(i.uniform.pose,f),gl.enableVertexAttribArray(i.attribute.xyz1),gl.enableVertexAttribArray(i.attribute.xyz2),gl.enableVertexAttribArray(i.attribute.normal),gl.enableVertexAttribArray(i.attribute.uv),gl.enableVertexAttribArray(i.attribute.bones),gl.enableVertexAttribArray(i.attribute.bias),_mdl.meshes.forEach(e=>{n(_mdl.materials[e.slot],_body[e.slot],_equip[e.slot]);gl.bindBuffer(gl.ARRAY_BUFFER,e.verts);t("xyz1",3,gl.FLOAT,!1,40,0);t("xyz2",3,gl.FLOAT,!1,40,12);t("uv",2,gl.FLOAT,!1,40,24);t("normal",3,gl.BYTE,!0,40,32);t("bias",1,gl.UNSIGNED_BYTE,!0,40,35);t("bones",2,gl.UNSIGNED_BYTE,!1,40,36);gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,e.indices);gl.drawElements(gl.TRIANGLES,e.nindices,gl.UNSIGNED_SHORT,0)}),gl.disableVertexAttribArray(i.attribute.bias),gl.disableVertexAttribArray(i.attribute.bones),gl.disableVertexAttribArray(i.attribute.uv),gl.disableVertexAttribArray(i.attribute.normal),gl.disableVertexAttribArray(i.attribute.xyz2),gl.disableVertexAttribArray(i.attribute.xyz1),a(_static,!1),gl.uniformMatrix4fv(i.uniform._pm,!1,_pm),gl.enableVertexAttribArray(i.attribute.xyz),gl.enableVertexAttribArray(i.attribute.normal),gl.enableVertexAttribArray(i.attribute.uv),gl.disable(gl.CULL_FACE),l(_head,"Attractor01_head"),gl.enable(gl.CULL_FACE),_weap1&&l(_weap1,"Attractor02_righthand"),_weap2&&l(_weap2,"Attractor03_lefthand"),gl.disableVertexAttribArray(i.attribute.uv),gl.disableVertexAttribArray(i.attribute.normal),gl.disableVertexAttribArray(i.attribute.xyz)}if(_doskel){let a=[];for(let e=1;e<_mdl.bones.length;e++){let t=c[_mdl.bones[e].parent];a.push(t[12],t[13],t[14]),a.push(c[e][12],c[e][13],c[e][14])}gl.bindBuffer(gl.ARRAY_BUFFER,_lines),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(a),gl.DYNAMIC_DRAW),e(_pr_simple),gl.uniformMatrix4fv(i.uniform._pmv,!1,_pmv),gl.uniform4f(i.uniform._colour,0,1,0,1),gl.disable(gl.DEPTH_TEST),gl.enableVertexAttribArray(i.attribute.xyz),t("xyz",3,gl.FLOAT,!1,0,0),gl.drawArrays(gl.LINES,0,a.length/3),gl.disableVertexAttribArray(i.attribute.xyz),gl.enable(gl.DEPTH_TEST)}_dolight&&(e(_pr_simple),gl.uniformMatrix4fv(i.uniform._pmv,!1,_pmv),gl.uniform4f(i.uniform._colour,1,.2,.2,1),gl.bindBuffer(gl.ARRAY_BUFFER,_lines),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(u),gl.DYNAMIC_DRAW),gl.enableVertexAttribArray(i.attribute.xyz),t("xyz",3,gl.FLOAT,!1,0,0),gl.drawArrays(gl.POINTS,0,1),gl.uniform4f(i.uniform._colour,1,.5,.5,1),gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([0,0,0,u[0],u[1],u[2]]),gl.DYNAMIC_DRAW),gl.drawArrays(gl.LINES,0,2),gl.disableVertexAttribArray(i.attribute.xyz)),gl.finish(),window.requestAnimationFrame(aoview_frame)}function aoview_keydown(e){if(!_inhibit)switch(e.key){case"Shift":_mode=M_LIGHT}}function aoview_keyup(e){if(!_inhibit)switch(e.key){case"Shift":_mode=0;break;case" ":_dopause=!_dopause;break;case"s":_doskel=!_doskel;break;case"e":_doequip=!_doequip;break;case"l":_dolight=!_dolight}}function aoview_mousedown(e){e.shiftKey||(_mode=0,3==e.buttons?_mode=M_PAN:2==e.buttons&&(_mode=M_DOLLY)),_held=!0,_ox=e.clientX,_oy=e.clientY}function aoview_mouseup(){_held=!1}function aoview_mouseover(e){(_held=0!=e.buttons)&&(_ox=e.clientX,_oy=e.clientY)}function aoview_mousemove(e){if(_inhibit)return;if(!_held)return;_mx=e.clientX,_my=e.clientY;let t=.2*(_mx-_ox),a=.2*(_my-_oy);switch(_ox=_mx,_oy=_my,_mode){case M_LIGHT:_light_angles[0]+=t,_light_angles[1]+=a;break;case M_DOLLY:_cam_velo[2]+=a;break;case M_PAN:_cam_velo[0]+=t,_cam_velo[1]-=a;break;default:_velo[0]+=30*t,_velo[1]+=30*a}}async function aoview_init(){let e={trans:"transform.glsl",col:"colour.glsl",static:"static.glsl",tex:"texture.glsl",skin:"skin.glsl",common:"common.glsl"};webgl_init();let t={};Object.keys(e).forEach(a=>{t[a]=webgl_get(e[a])}),_pm=new Float32Array(16),_mm=new Float32Array(16),_pmv=new Float32Array(16),_cam_angles=new Float32Array([180,10,0]),_cam_pos=new Float32Array([0,0,2]),_cam_velo=new Float32Array([0,0,0]),_light_angles=new Float32Array([230,45,0]),_velo=new Float32Array([0,0,0]),_colour=[.3,.3,.3,1],gl.enable(gl.DEPTH_TEST),gl.enable(gl.CULL_FACE),gl.cullFace(gl.FRONT),gl.depthFunc(gl.LEQUAL),gl.clearColor(_colour[0],_colour[1],_colour[2],_colour[3]),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),_lines=gl.createBuffer(),_time=performance.now(),_mode=0,_ox=0,_oy=0,_mx=0,_my=0,_held=!1,_equip={},_equip2={},_breed=null,_scale=1,_build="medium",_breed_latched=_breed_info.atrox;let a=parse_qs();if(a){let e={},t=0,n="",l="";if(Object.keys(a).forEach(i=>{switch(i){case"breed":{let e=a[i];switch(e){case"atrox":case"soli_f":case"soli_m":case"opi_f":case"opi_m":case"nano_f":case"nano_m":_breed_latched=_breed_info[e]}break}case"build":switch(a[i]){case"s":_build="thin";break;case"l":_build="fat";break;case"m":default:_build="medium"}break;case"height":switch(a[i]){case"s":_scale=.9;break;case"l":_scale=1.1;break;case"m":default:_scale=1}break;case"face":t=parseInt(a[i]);break;case"body":case"arms":case"legs":case"feet":case"hands":e[i]="data/textures/"+a[i];break;case"weap1":n=parseInt(a[i]);break;case"weap2":l=parseInt(a[i])}}),""!=n){let e=await webgl_get("data/weapons/"+n+".abo",!0);e&&(_weap1=load_abo(e))}if(""!=l){let e=await webgl_get("data/weapons/"+l+".abo",!0);e&&(_weap2=load_abo(e))}_breed_latched.lasthead=t,_equip2=e}let n=0,l=Object.keys(t).length,i={};load_init("Loading shaders...");for(let e of Object.keys(t))i[e]=await t[e],load_progress(n/l),n++;webgl_clear2d(),webgl_header_source(i.common),_pr_simple=webgl_create_program("simple",i.trans,i.col),_pr_static=webgl_create_program("static",i.static,i.tex),_pr_skin=webgl_create_program("skin",i.skin,i.tex),_pr_simple&&_pr_static&&_pr_skin||webgl_fatal("Failed to create shaders");let r=document.getElementById("canvas");document.addEventListener("keydown",aoview_keydown),document.addEventListener("keyup",aoview_keyup),document.addEventListener("mousemove",aoview_mousemove),document.addEventListener("mouseup",aoview_mouseup),r.addEventListener("mousedown",aoview_mousedown),r.addEventListener("mouseover",aoview_mouseover),r.addEventListener("contextmenu",e=>{e.preventDefault();return!1});let _=document.getElementById("anims");_.addEventListener("change",()=>{change_anim(_.value)}),document.getElementById("ui_atrox").addEventListener("click",()=>{_breed_latched=_breed_info.atrox}),document.getElementById("ui_solif").addEventListener("click",()=>{_breed_latched=_breed_info.soli_f}),document.getElementById("ui_solim").addEventListener("click",()=>{_breed_latched=_breed_info.soli_m}),document.getElementById("ui_opif").addEventListener("click",()=>{_breed_latched=_breed_info.opi_f}),document.getElementById("ui_opim").addEventListener("click",()=>{_breed_latched=_breed_info.opi_m}),document.getElementById("ui_nanof").addEventListener("click",()=>{_breed_latched=_breed_info.nano_f}),document.getElementById("ui_nanom").addEventListener("click",()=>{_breed_latched=_breed_info.nano_m}),document.getElementById("ui_sm").addEventListener("click",()=>{change_model("thin")}),document.getElementById("ui_me").addEventListener("click",()=>{change_model("medium")}),document.getElementById("ui_lg").addEventListener("click",()=>{change_model("fat")}),document.getElementById("ui_dn").addEventListener("click",()=>{_scale-=.1;_scale<=.9&&(_scale=.9)}),document.getElementById("ui_up").addEventListener("click",()=>{_scale+=.1;_scale>=1.1&&(_scale=1.1)}),document.getElementById("ui_prev").addEventListener("click",()=>{--_breed.lasthead<0&&(_breed.lasthead=0);change_head(_breed.lasthead)}),document.getElementById("ui_next").addEventListener("click",()=>{++_breed.lasthead>=_breed.heads&&(_breed.lasthead=_breed.heads-1);change_head(_breed.lasthead)}),window.requestAnimationFrame(aoview_frame)}var gl,wgl_canvas,wgl_hud,wgl_2d,wgl_header,wgl_tmu=[-1,-1,-1,-1],wgl_image_canvas=document.createElement("canvas"),wgl_image_ctx=wgl_image_canvas.getContext("2d"),wgl_pending_images=[],_breed_info={atrox:{breed:"atrox",sex:"neuter",heads:42,lasthead:0,clothes:{body:"9236",arms:"9233",legs:"9234",hands:"9235",feet:"9231"},skin:{body:"9238",arms:"9243",legs:"9255",hands:"9240",feet:"9239"},ofs:{thin:.01,medium:0,fat:0}},soli_f:{breed:"solitus",sex:"female",heads:76,lasthead:0,clothes:{body:"8848",arms:"8849",legs:"8853",hands:"8852",feet:"8850"},skin:{body:"8859",arms:"8856",legs:"8881",hands:"8865",feet:"8862"},skin1:{body:"8857",arms:"8855",legs:"8879",hands:"8863",feet:"8860"},skin2:{body:"8858",arms:"8854",legs:"8880",hands:"8864",feet:"8861"},ofs:{thin:-.022,medium:0,fat:.05}},opi_f:{breed:"opifex",sex:"female",heads:51,lasthead:0,clothes:{body:"8883",arms:"8885",legs:"8884",hands:"8887",feet:"8886"},skin:{body:"body",arms:"arms",legs:"legs",hands:"hands",feet:"feet"},ofs:{thin:.07,medium:.07,fat:.07}},nano_f:{breed:"nanomage",sex:"female",heads:44,lasthead:0,clothes:{body:"9026",arms:"9028",legs:"9027",hands:"9023",feet:"9024"},skin:{body:"9217",arms:"9223",legs:"9230",hands:"9219",feet:"9218"},ofs:{thin:-.03,medium:0,fat:.05}},soli_m:{breed:"solitus",sex:"male",heads:75,lasthead:0,clothes:{body:"8709",arms:"8714",legs:"8713",hands:"8712",feet:"8710"},skin:{body:"8767",arms:"8774",legs:"8768",hands:"8773",feet:"8761"},skin1:{body:"8763",arms:"8769",legs:"8764",hands:"8770",feet:"8762"},skin2:{body:"8766",arms:"8772",legs:"8765",hands:"8771",feet:"8760"},ofs:{thin:.01,medium:0,fat:.026}},opi_m:{breed:"opifex",sex:"male",heads:47,lasthead:0,clothes:{body:"8961",arms:"8964",legs:"8965",hands:"8963",feet:"8960"},skin:{body:"8967",arms:"8974",legs:"8981",hands:"8969",feet:"8968"},ofs:{thin:.022,medium:.022,fat:.022}},nano_m:{breed:"nanomage",sex:"male",heads:42,lasthead:0,clothes:{body:"8982",arms:"8986",legs:"8985",hands:"8984",feet:"8983"},skin:{body:"8991",arms:"8999",legs:"9005",hands:"8993",feet:"8992"},ofs:{thin:-.04,medium:0,fat:.03}}},_sex_anims={female:{idle:"10135",walk:"10162",run:"10146",disco:"12867"},male:{idle:"10173",walk:"10191",run:"10194",disco:"14824"},neuter:{idle:"9992",walk:"10078",run:"9386",disco:"10033"}},M_PAN=1,M_LIGHT=2,M_DOLLY=3,_ox,_oy,_mx,_my,_mode,_held,_pm,_mm,_pmv,_cam_angles,_cam_pos,_cam_velo,_light_angles,_anim,_lines,_mdl,_body={},_head,_doskel=!1,_dolight=!1,_doskin=!0,_dopause=!1,_doequip=!0,_velo,_pr_simple,_pr_static,_pr_skin,_static,_skin,_colour,_time,_anim_time=0,_equip,_equip2,_equip_latched=null,_weap1=null,_weap2=null,_breed,_breed_latched,_anims=null,_head_req=null,_mdl_req=null,_breed_skin=null,_build,_scale,_inhibit=!1,t1=new Float32Array(16),t2=new Float32Array(16),t3=new Float32Array(16),t4=new Float32Array(16),_pose=[],_vecs=[];aoview_init();
